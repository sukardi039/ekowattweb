# Environment Variable Troubleshooting Guide

## Updated Files

I've enhanced the docker-entrypoint.sh with extensive logging to help diagnose the issue:

- Shows the BMP_URL value at startup
- Displays the generated env.js content
- Logs each step of the injection process

## How to Verify in Dokploy

### 1. Check Container Logs

In Dokploy, view the container logs. You should see:

```
=== Docker Entrypoint Starting ===
BMP_URL environment variable: https://your-url.com
Injecting BMP_URL: https://your-url.com
env.js content:
// Auto-generated by Docker entrypoint
window.BMP_URL = "https://your-url.com";
console.log("env.js loaded with BMP_URL:", window.BMP_URL);
=== Injection Complete ===
=== Starting nginx ===
```

### 2. Check if BMP_URL is Set

If you see:

```
WARNING: BMP_URL is not set. Using existing config.json/env.js.
```

Then the environment variable is NOT being passed to the container.

**Fix in Dokploy:**

- Go to your app settings
- Find Environment Variables section
- Add: `BMP_URL` = `https://your-bmp-url.com`
- Redeploy

### 3. Verify Files in Running Container

If you have shell access to the container:

```bash
# Check env.js
cat /usr/share/nginx/html/env.js

# Check config.json
cat /usr/share/nginx/html/config.json
```

Both should contain your BMP_URL.

### 4. Check Browser

Open your deployed site:

1. Open browser DevTools (F12)
2. Go to Console tab
3. Look for: `"env.js loaded with BMP_URL: https://..."`
4. Look for: `"Config loaded from runtime env (window.BMP_URL): ..."`

### 5. Check env.js File Directly

Visit: `https://your-domain.com/env.js`

You should see:

```javascript
// Auto-generated by Docker entrypoint
window.BMP_URL = "https://your-url.com";
console.log("env.js loaded with BMP_URL:", window.BMP_URL);
```

If you see the comments only (no window.BMP_URL assignment), the entrypoint didn't run or BMP_URL wasn't set.

## Common Issues

### Issue 1: Environment Variable Not Set in Dokploy

**Symptom:** Container logs show "BMP_URL is not set"
**Fix:** Add BMP_URL environment variable in Dokploy dashboard

### Issue 2: Entrypoint Not Running

**Symptom:** env.js still has comments only
**Fix:** Ensure Dockerfile has `ENTRYPOINT ["/docker-entrypoint.sh"]`

### Issue 3: Browser Cache

**Symptom:** Old config still loading
**Fix:** Hard refresh (Ctrl+Shift+R) or clear browser cache

### Issue 4: Line Ending Issues

**Symptom:** Entrypoint script fails silently
**Fix:** Already handled in Dockerfile with `sed -i 's/\r$//'`

## Test Locally (if Docker Desktop is running)

```bash
# Build image
docker build -t ekowatt-landing .

# Run with environment variable
docker run -d -p 8080:80 --name ekowatt-test -e BMP_URL=https://test.example.com ekowatt-landing

# Check logs
docker logs ekowatt-test

# Check env.js
docker exec ekowatt-test cat /usr/share/nginx/html/env.js

# Visit http://localhost:8080 and check console

# Clean up
docker stop ekowatt-test && docker rm ekowatt-test
```

## Next Steps

1. Rebuild the Docker image in Dokploy (or commit and let it rebuild from git)
2. Check the container logs in Dokploy
3. Share the logs with me if you still see issues
